# Changelog: Приватное хранилище файлов доказательств

**Дата**: 2026-01-19

## Что изменилось

### Безопасность файлов доказательств выполнения задач

Реализована полная система безопасности для загружаемых файлов доказательств выполнения задач (`completion_with_proof`).

### Основные изменения

#### 1. Приватное хранилище (config/filesystems.php)
- Добавлен диск `task_proofs` с приватным доступом
- Файлы хранятся в `storage/app/private/task_proofs/`
- Недоступны напрямую через веб-сервер

#### 2. Транзакционная загрузка (app/Services/TaskProofService.php)
- Полная переработка сервиса с использованием транзакций
- Откат всех файлов при ошибке загрузки любого из них
- Валидация содержимого файлов:
  - `getimagesize()` для изображений (JPG, PNG, GIF, WebP)
  - Magic bytes для PDF (`%PDF`) и ZIP (`PK`)
  - `finfo` для видео (MP4, MOV)
- Предотвращение подмены расширений файлов

#### 3. Подписанные URL (app/Models/TaskProof.php)
- Временные URL с подписью (срок действия 60 минут)
- Использование `URL::temporarySignedRoute()`
- Автоматическая генерация через аксессор `url`

#### 4. Endpoint скачивания с авторизацией (app/Http/Controllers/Api/V1/TaskProofController.php)
Трёхуровневая проверка безопасности:
1. **Проверка подписи URL** — защита от подделки ссылок
2. **Bearer токен** — требуется авторизация через Sanctum
3. **Проверка прав доступа**:
   - Владелец системы (owner) — полный доступ
   - Создатель задачи — доступ к своим задачам
   - Назначенный исполнитель — доступ к назначенным задачам
   - Пользователи с доступом к автосалону задачи

#### 5. Маршрут (routes/api.php)
```php
Route::get('/task-proofs/{id}/download', [TaskProofController::class, 'download'])
    ->name('task-proofs.download');
```

### Готовность к S3

Система полностью готова к миграции на S3-совместимое хранилище:
- AWS S3
- DigitalOcean Spaces
- MinIO
- Yandex Object Storage

Для миграции достаточно:
1. Установить `league/flysystem-aws-s3-v3`
2. Обновить конфиг диска `task_proofs` в `filesystems.php`
3. Добавить credentials в `.env`

### Тестирование

Все 193 теста успешно проходят:
- ✅ Unit тесты моделей
- ✅ Feature тесты API endpoints
- ✅ Тесты безопасности и авторизации

### Документация

Обновлена документация:
- ✅ `README.md` — обновлены команды и тестирование
- ✅ `TaskMateBackend/CLAUDE.md` — добавлен раздел "Хранилище файлов"
- ✅ `TaskMateBackend/README.md` — обновлены команды инициализации
- ✅ `CLAUDE.md` (корневой) — добавлен раздел "File Upload & Security"

## Файлы изменены

### Новые файлы
- `CHANGELOG_FILE_UPLOAD.md` — этот файл

### Изменённые файлы
1. `config/filesystems.php` — добавлен диск `task_proofs`
2. `app/Services/TaskProofService.php` — полная переработка с транзакциями
3. `app/Models/TaskProof.php` — подписанные URL
4. `app/Http/Controllers/Api/V1/TaskProofController.php` — метод `download()`
5. `routes/api.php` — добавлен маршрут скачивания
6. `tests/Feature/Api/TaskControllerTest.php` — фикс тестов (использование state `completion()`)
7. `README.md` — актуализация
8. `TaskMateBackend/README.md` — актуализация
9. `TaskMateBackend/CLAUDE.md` — актуализация
10. `CLAUDE.md` — актуализация

## Проверка безопасности

### Защита от атак
- ✅ Защита от прямого доступа к файлам (приватная директория)
- ✅ Защита от подделки URL (подписанные URL)
- ✅ Защита от несанкционированного доступа (Bearer токен)
- ✅ Защита от подмены расширений (валидация содержимого)
- ✅ Защита от частичной загрузки (транзакции с откатом)

### Ограничения
- Максимум 5 файлов на задачу
- Общий размер до 200 МБ
- Поддерживаемые форматы: JPG, PNG, GIF, WebP, MP4, MOV, PDF, ZIP
- Временные URL действительны 60 минут

## Следующие шаги (опционально)

1. Настроить CDN для S3 (если используется)
2. Настроить автоматическую очистку старых файлов
3. Добавить сжатие изображений перед сохранением
4. Добавить генерацию превью для видео
