services:
    valkey:
        image: valkey/valkey:latest
        container_name: taskmate_valkey
        restart: on-failure
        volumes:
            - valkey_data:/data
            - ./valkey.conf:/etc/valkey/valkey.conf:ro
        command: [ "valkey-server", "/etc/valkey/valkey.conf" ]
        networks:
            - web
        healthcheck:
            test: [ "CMD", "sh", "-c", "nc -z localhost 6379 || exit 1" ]
            interval: 10s
            timeout: 3s
            retries: 5

    postgres:
        image: postgres:18
        container_name: taskmate_postgres
        restart: on-failure
        env_file: [ ./.env ]
        environment:
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro
        networks:
            - web
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d postgres" ]
            interval: 10s
            timeout: 5s
            retries: 6

    src_frontend:
        build:
            context: ./TaskMateFrontend/
            dockerfile: Dockerfile
        container_name: taskmate_src_frontend
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        args:
            VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8007/api/v1}
        networks:
            - web

    src_telegram_bot_api:
        build:
            context: ./TaskMateTelegramBot/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_src_telegram_bot_api
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            APP_DEBUG: ${DEBUG_MODE}
            APP_ENV: ${APP_ENVIRONMENT}
            APP_KEY: ${TASK_MATE_TELEGRAM_BOT_APP_KEY}
            APP_URL: ${TASK_MATE_TELEGRAM_BOT_APP_URL}
            APP_TIMEZONE: ${APP_TIMEZONE}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_DATABASE: ${DB_DATABASE_TASK_MATE_TELEGRAM_BOT}
            DB_USER: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            TELEGRAM_TOKEN: ${TASK_MATE_TELEGRAM_BOT_TOKEN}
            VCRM_API_URL: ${VCRM_API_URL}
            VCRM_API_TOKEN: ${VCRM_API_TOKEN}
            NUTGRAM_LOG_CHAT_ID: ${TASK_MATE_TELEGRAM_BOT_LOG_CHAT_ID}
        volumes:
            - ./TaskMateTelegramBot/:/var/www/src_telegram_bot_api
            - ./TaskMateTelegramBot/.env:/var/www/src_telegram_bot_api/.env
            - ./wait-for-it.sh:/wait-for-it.sh:ro
        networks:
            - web
        depends_on:
            - postgres
            - valkey

    src_telegram_bot_scheduler:
        build:
            context: ./TaskMateTelegramBot/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_src_telegram_bot_scheduler
        restart: unless-stopped
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            APP_DEBUG: ${DEBUG_MODE}
            APP_ENV: ${APP_ENVIRONMENT}
            APP_KEY: ${TASK_MATE_TELEGRAM_BOT_APP_KEY}
            APP_URL: ${TASK_MATE_TELEGRAM_BOT_APP_URL}
            APP_TIMEZONE: ${APP_TIMEZONE}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_DATABASE: ${DB_DATABASE_TASK_MATE_TELEGRAM_BOT}
            DB_USER: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            TELEGRAM_TOKEN: ${TASK_MATE_TELEGRAM_BOT_TOKEN}
            QUEUE_CONNECTION: valkey
        volumes:
            - ./TaskMateTelegramBot/:/var/www/src_telegram_bot_api
            - ./TaskMateTelegramBot/.env:/var/www/src_telegram_bot_api/.env
            - ./TaskMateTelegramBot/supervisor.conf:/etc/supervisor/conf.d/supervisor.conf:ro
        depends_on:
            - postgres
            - valkey
        networks:
            - web
        command: [ "supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisor.conf" ]

    nginx:
        image: nginx:latest
        container_name: taskmate_nginx
        restart: on-failure
        volumes:
            - ./nginx/nginx.local.conf:/etc/nginx/conf.d/default.conf:ro
            - ./TaskMateTelegramBot/:/var/www/src_telegram_bot_api:ro
            - ./certbot/www:/var/www/certbot
            - ./certbot/conf:/etc/letsencrypt
        networks:
            - web
        depends_on:
            - src_frontend
            - src_telegram_bot_api
            - src_telegram_bot_scheduler

    certbot:
        image: certbot/certbot
        container_name: taskmate_certbot
        volumes:
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
        networks:
            - web
        profiles: [ "certbot" ]

volumes:
    valkey_data:
    postgres_data:
    pgadmin_data:


networks:
    web:
        driver: bridge
