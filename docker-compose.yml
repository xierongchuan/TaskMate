x-backend-env: &backend-env
    APP_DEBUG: ${DEBUG_MODE}
    APP_ENV: ${APP_ENVIRONMENT}
    APP_KEY: ${TASK_MATE_BACKEND_APP_KEY}
    APP_URL: ${TASK_MATE_BACKEND_APP_URL}
    APP_TIMEZONE: ${APP_TIMEZONE}
    DB_CONNECTION: ${DB_CONNECTION}
    DB_HOST: ${DB_HOST}
    DB_PORT: ${DB_PORT}
    DB_DATABASE: ${DB_DATABASE_TASK_MATE_BACKEND}
    DB_USERNAME: ${DB_USERNAME}
    DB_PASSWORD: ${DB_PASSWORD}
    QUEUE_CONNECTION: rabbitmq
    RABBITMQ_HOST: rabbitmq
    RABBITMQ_PORT: 5672
    RABBITMQ_USER: ${RABBITMQ_USER:-taskmate}
    RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-taskmate_secret}
    RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}

x-backend-worker: &backend-worker
    build:
        context: ./TaskMateServer/
        dockerfile: Dockerfile
        target: runner
    restart: unless-stopped
    env_file: [ ./.env ]
    extra_hosts:
        - "host.docker.internal:host-gateway"
    environment:
        <<: *backend-env
    volumes:
        - ./TaskMateServer/.env:/app/.env:z
        - ./TaskMateServer/storage/app/private:/app/storage/app/private:z
    depends_on:
        postgres:
            condition: service_healthy
        rabbitmq:
            condition: service_healthy
    networks:
        - web

x-worker-command: &worker-command
    /bin/bash -c "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=${QUEUE_NAME} --sleep=5 --tries=3 --max-time=3600"

services:
    valkey:
        image: docker.io/valkey/valkey:9.0.1
        container_name: taskmate_valkey
        restart: on-failure
        volumes:
            - valkey_data:/data
            - ./valkey.conf:/etc/valkey/valkey.conf:ro,Z
        command: [ "valkey-server", "/etc/valkey/valkey.conf" ]
        networks:
            - web
        healthcheck:
            test: [ "CMD", "valkey-cli", "ping" ]
            interval: 10s
            timeout: 5s
            retries: 3

    rabbitmq:
        image: docker.io/library/rabbitmq:4-management-alpine
        container_name: taskmate_rabbitmq
        restart: on-failure
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-taskmate}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-taskmate_secret}
            RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        networks:
            - web
        healthcheck:
            test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
            interval: 10s
            timeout: 5s
            retries: 5

    postgres:
        image: docker.io/library/postgres:18.1
        container_name: taskmate_postgres
        restart: on-failure
        env_file: [ ./.env ]
        environment:
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
            POSTGRES_DB: ${DB_DATABASE_TASK_MATE_BACKEND}
        volumes:
            - postgres_data:/var/lib/postgresql
            - ./init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro,Z
        networks:
            - web
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d postgres" ]
            interval: 10s
            timeout: 5s
            retries: 6

    src_frontend:
        build:
            context: ./TaskMateClient/
            dockerfile: Dockerfile
            args:
                VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        container_name: taskmate_src_frontend
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        networks:
            - web

    backend_api:
        build:
            context: ./TaskMateServer/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_backend_api
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            <<: *backend-env
            VCRM_API_URL: ${VCRM_API_URL:-}
            VCRM_API_TOKEN: ${VCRM_API_TOKEN:-}
            SERVER_NAME: ":8000"
        volumes:
            - ./TaskMateServer/.env:/app/.env:z
            - ./wait-for-it.sh:/wait-for-it.sh:ro,Z
            - ./TaskMateServer/storage/app/private:/app/storage/app/private:z
        networks:
            - web
        depends_on:
            - postgres
            - valkey
            - rabbitmq

    backend_scheduler:
        build:
            context: ./TaskMateServer/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_backend_scheduler
        restart: unless-stopped
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            <<: *backend-env
        volumes:
            - ./TaskMateServer/.env:/app/.env:z
            - ./TaskMateServer/supervisor.conf:/etc/supervisor/conf.d/supervisor.conf:ro,Z
            - ./TaskMateServer/sync-scheduler.sh:/app/sync-scheduler.sh:ro,Z
            - ./TaskMateServer/storage/app/private:/app/storage/app/private:z
        depends_on:
            postgres:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        networks:
            - web
        command: [ "/bin/bash", "-c", "chown -R www-data:www-data /app/storage && chmod -R g+rwX /app/storage && find /app/storage -type d -exec chmod g+s {} + && exec supervisord -n -c /etc/supervisor/conf.d/supervisor.conf" ]
        healthcheck:
            disable: true

    backend_worker_cleanup:
        <<: *backend-worker
        container_name: taskmate_worker_cleanup
        command: [ "/bin/bash", "-c", "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=file_cleanup --sleep=5 --tries=3 --max-time=3600" ]

    backend_worker_proof_upload:
        <<: *backend-worker
        container_name: taskmate_worker_proof_upload
        command: [ "/bin/bash", "-c", "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=proof_upload --sleep=5 --tries=3 --max-time=3600" ]

    backend_worker_shared_proof:
        <<: *backend-worker
        container_name: taskmate_worker_shared_proof
        command: [ "/bin/bash", "-c", "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=shared_proof_upload --sleep=5 --tries=3 --max-time=3600" ]

    backend_worker_generators:
        <<: *backend-worker
        container_name: taskmate_worker_generators
        volumes:
            - ./TaskMateServer/.env:/app/.env:z
        command: [ "/bin/bash", "-c", "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=task_generators --sleep=5 --tries=3 --max-time=3600" ]

    backend_worker_shift_close:
        <<: *backend-worker
        container_name: taskmate_worker_shift_close
        volumes:
            - ./TaskMateServer/.env:/app/.env:z
        command: [ "/bin/bash", "-c", "rm -f /app/bootstrap/cache/services.php /app/bootstrap/cache/packages.php && php /app/artisan package:discover && exec php /app/artisan queue:work rabbitmq --queue=shift_auto_close --sleep=5 --tries=3 --max-time=3600" ]

    nginx:
        image: docker.io/library/nginx:1.27-alpine
        container_name: taskmate_nginx
        restart: on-failure
        volumes:
            - ./certbot/www:/var/www/certbot:z
            - ./certbot/conf:/etc/letsencrypt:z
        networks:
            - web
        depends_on:
            - src_frontend
            - backend_api

    certbot:
        image: docker.io/certbot/certbot:v4.0.0
        container_name: taskmate_certbot
        volumes:
            - ./certbot/conf:/etc/letsencrypt:z
            - ./certbot/www:/var/www/certbot:z
        networks:
            - web
        profiles: [ "certbot" ]

    telegram_bot:
        build:
            context: ./TaskMateTelegramBot/
            dockerfile: Dockerfile
        container_name: taskmate_bot
        restart: on-failure
        env_file: [ ./.env ]
        environment:
            TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
            TASKMATE_API_URL: http://backend_api:8000/api/v1
            VALKEY_HOST: valkey
            VALKEY_PORT: 6379
            VALKEY_DB: 1
            LOG_LEVEL: ${BOT_LOG_LEVEL:-INFO}
        networks:
            - web
        depends_on:
            - backend_api
            - valkey

    telegram_bot_worker:
        build:
            context: ./TaskMateTelegramBot/
            dockerfile: Dockerfile
        container_name: taskmate_bot_worker
        restart: on-failure
        env_file: [ ./.env ]
        command: ["python", "-m", "src.worker"]
        environment:
            TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
            TASKMATE_API_URL: http://backend_api:8000/api/v1
            VALKEY_HOST: valkey
            VALKEY_PORT: 6379
            VALKEY_DB: 1
            RABBITMQ_HOST: rabbitmq
            RABBITMQ_PORT: 5672
            RABBITMQ_USER: ${RABBITMQ_USER:-taskmate}
            RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-taskmate_secret}
            RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
            LOG_LEVEL: ${BOT_LOG_LEVEL:-INFO}
        networks:
            - web
        depends_on:
            - valkey
            - rabbitmq


volumes:
    valkey_data:
    postgres_data:
    rabbitmq_data:

networks:
    web:
        driver: bridge
