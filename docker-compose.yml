services:
    valkey:
        image: valkey/valkey:latest
        container_name: taskmate_valkey
        restart: on-failure
        volumes:
            - valkey_data:/data
            - ./valkey.conf:/etc/valkey/valkey.conf:ro
        command: [ "valkey-server", "/etc/valkey/valkey.conf" ]
        networks:
            - web

    postgres:
        image: postgres:18
        container_name: taskmate_postgres
        restart: on-failure
        env_file: [ ./.env ]
        environment:
            POSTGRES_USER: ${DB_USERNAME}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        volumes:
            - postgres_data:/var/lib/postgresql
            - ./init-multiple-dbs.sh:/docker-entrypoint-initdb.d/init-multiple-dbs.sh:ro
        networks:
            - web
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d postgres" ]
            interval: 10s
            timeout: 5s
            retries: 6

    src_frontend:
        build:
            context: ./TaskMateFrontend/
            dockerfile: Dockerfile
            args:
                VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        container_name: taskmate_src_frontend
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        networks:
            - web

    backend_api:
        build:
            context: ./TaskMateBackend/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_backend_api
        restart: on-failure
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            APP_DEBUG: ${DEBUG_MODE}
            APP_ENV: ${APP_ENVIRONMENT}
            APP_KEY: ${TASK_MATE_BACKEND_APP_KEY}
            APP_URL: ${TASK_MATE_BACKEND_APP_URL}
            APP_TIMEZONE: ${APP_TIMEZONE}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_DATABASE: ${DB_DATABASE_TASK_MATE_BACKEND}
            DB_USER: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            VCRM_API_URL: ${VCRM_API_URL:-}
            VCRM_API_TOKEN: ${VCRM_API_TOKEN:-}
            # FrankenPHP настройки
            SERVER_NAME: ":8000"
        volumes:
            - ./TaskMateBackend/.env:/app/.env
            - ./wait-for-it.sh:/wait-for-it.sh:ro
        networks:
            - web
        depends_on:
            - postgres
            - valkey

    backend_scheduler:
        build:
            context: ./TaskMateBackend/
            dockerfile: Dockerfile
            target: runner
        container_name: taskmate_backend_scheduler
        restart: unless-stopped
        env_file: [ ./.env ]
        extra_hosts:
            - "host.docker.internal:host-gateway"
        environment:
            APP_DEBUG: ${DEBUG_MODE}
            APP_ENV: ${APP_ENVIRONMENT}
            APP_KEY: ${TASK_MATE_BACKEND_APP_KEY}
            APP_URL: ${TASK_MATE_BACKEND_APP_URL}
            APP_TIMEZONE: ${APP_TIMEZONE}
            DB_CONNECTION: ${DB_CONNECTION}
            DB_HOST: ${DB_HOST}
            DB_PORT: ${DB_PORT}
            DB_DATABASE: ${DB_DATABASE_TASK_MATE_BACKEND}
            DB_USER: ${DB_USERNAME}
            DB_PASSWORD: ${DB_PASSWORD}
            QUEUE_CONNECTION: valkey
        volumes:
            - ./TaskMateBackend/.env:/app/.env
            - ./TaskMateBackend/supervisor.conf:/etc/supervisor/conf.d/supervisor.conf:ro
            - ./TaskMateBackend/sync-scheduler.sh:/app/sync-scheduler.sh:ro
        depends_on:
            - postgres
            - valkey
        networks:
            - web
        command: [ "supervisord", "-n", "-c", "/etc/supervisor/conf.d/supervisor.conf" ]
        healthcheck:
            disable: true

    nginx:
        image: nginx:latest
        container_name: taskmate_nginx
        restart: on-failure
        volumes:
            - ./certbot/www:/var/www/certbot
            - ./certbot/conf:/etc/letsencrypt
        networks:
            - web
        depends_on:
            - src_frontend
            - backend_api

    certbot:
        image: certbot/certbot
        container_name: taskmate_certbot
        volumes:
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
        networks:
            - web
        profiles: [ "certbot" ]

volumes:
    valkey_data:
    postgres_data:
    pgadmin_data:


networks:
    web:
        driver: bridge
